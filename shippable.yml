language: node_js

node_js:
  - 7

branches:
  only:
    - master-ci-shippable

env:
  global:
  - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
  - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
  - TESTS_LOC_DIR=$SHIPPABLE_REPO_DIR/test
  - MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin/
  - secure: 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
  
build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/node_modules
  ci:
    - shippable_retry npm install
    - mkdir -p $TEST_RESULTS_DIR && mkdir -p $CODE_COVERAGE_DIR
    - pushd $TESTS_LOC_DIR
    - $MOD_LOC/mocha --recursive "$TESTS_LOC_DIR/**/*.spec.js" -R mocha-junit-reporter --reporter-options mochaFile=$TEST_RESULTS_DIR/testresults.xml
    - $MOD_LOC/istanbul --include-all-sources cover $MOD_LOC/_mocha -- --recursive "$TESTS_LOC_DIR/**/*.spec.js" --ui=bdd -R xunit-file
    - $MOD_LOC/istanbul report cobertura --dir $CODE_COVERAGE_DIR
    - popd

jobs:
  - name: GAE Deploy
    type: deploy
    steps:
      - TASK:
        - script: export CLOUDSDK_CORE_DISABLE_PROMPTS=1
          # Google Cloud SDK is pinned for build reliability. Bump if the SDK complains about deprecation.
        - script: SDK_FILENAME=google-cloud-sdk-$GCLOUD_SDK_VERSION-linux-x86_64.tar.gz
        - script: curl -O -J https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME}
        - script: tar -zxf ${SDK_FILENAME} --directory $HOME
        - script: echo 'export PATH=$HOME/google-cloud-sdk/bin:$PATH' >> $BASH_ENV
          # Install Google App Engine SDK
          # Install app & dev dependencies, test, deploy, test deployment (--quiet --verbosity=error )
        - script: echo $GOOGLE_CLIENT_SECRET > client-secret.json
        - script: gcloud auth activate-service-account --key-file client-secret.json
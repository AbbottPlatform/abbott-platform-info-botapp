language: node_js

node_js:
  - 7

branches:
  only:
    - master-ci-shippable

env:
  global:
  - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
  - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
  - TESTS_LOC_DIR=$SHIPPABLE_REPO_DIR/test
  - MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin/
  - secure: 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
  
build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/node_modules
  ci:
    - shippable_retry npm install
    - mkdir -p $TEST_RESULTS_DIR && mkdir -p $CODE_COVERAGE_DIR
    - pushd $TESTS_LOC_DIR
    - $MOD_LOC/mocha --recursive "$TESTS_LOC_DIR/**/*.spec.js" -R mocha-junit-reporter --reporter-options mochaFile=$TEST_RESULTS_DIR/testresults.xml
    - $MOD_LOC/istanbul --include-all-sources cover $MOD_LOC/_mocha -- --recursive "$TESTS_LOC_DIR/**/*.spec.js" --ui=bdd -R xunit-file
    - $MOD_LOC/istanbul report cobertura --dir $CODE_COVERAGE_DIR
    - popd
  post_ci:
    - export CLOUDSDK_CORE_DISABLE_PROMPTS=1
      # Google Cloud SDK is pinned for build reliability. Bump if the SDK complains about deprecation.
    - SDK_FILENAME=google-cloud-sdk-$GCLOUD_SDK_VERSION-linux-x86_64.tar.gz
    - curl -O -J https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME}
    - tar -zxf ${SDK_FILENAME} --directory $HOME
    - export PATH=$HOME/google-cloud-sdk/bin:$PATH
      # Install Google App Engine SDK
      # Install app & dev dependencies, test, deploy, test deployment (--quiet --verbosity=error )
    - echo $GOOGLE_CLIENT_SECRET > client-secret.json
    - gcloud auth activate-service-account --key-file client-secret.json
    - sed -i -e 's/'"%NLP_APIAI_TOKEN%"'/'"$NLP_APIAI_TOKEN"'/g' app.yaml
    - gcloud app deploy --project $GOOGLE_PROJECT_ID --version=beta-ci-shippable --no-stop-previous-version  --quiet

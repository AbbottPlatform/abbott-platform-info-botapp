language: node_js

node_js:
  - 7

branches:
  only:
    - master-ci-shippable

env:
  global:
  - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
  - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
  - TESTS_LOC_DIR=$SHIPPABLE_REPO_DIR/test
  - MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin/
  - secure: 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
  
build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/node_modules
  ci:
    - shippable_retry npm install
    - mkdir -p $TEST_RESULTS_DIR && mkdir -p $CODE_COVERAGE_DIR
    - pushd $TESTS_LOC_DIR
    - $MOD_LOC/mocha --recursive "$TESTS_LOC_DIR/**/*.spec.js" -R mocha-junit-reporter --reporter-options mochaFile=$TEST_RESULTS_DIR/testresults.xml
    - $MOD_LOC/istanbul --include-all-sources cover $MOD_LOC/_mocha -- --recursive "$TESTS_LOC_DIR/**/*.spec.js" --ui=bdd -R xunit-file
    - $MOD_LOC/istanbul report cobertura --dir $CODE_COVERAGE_DIR
    - popd
  post_ci:
    - export CLOUDSDK_CORE_DISABLE_PROMPTS=1
      # Google Cloud SDK is pinned for build reliability. Bump if the SDK complains about deprecation.
    - SDK_FILENAME=google-cloud-sdk-$GCLOUD_SDK_VERSION-linux-x86_64.tar.gz
    - curl -O -J https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME}
    - tar -zxf ${SDK_FILENAME} --directory $HOME
    - export PATH=$HOME/google-cloud-sdk/bin:$PATH
      # Install Google App Engine SDK
      # Install app & dev dependencies, test, deploy, test deployment (--quiet --verbosity=error )
    - echo $GOOGLE_CLIENT_SECRET > client-secret.json
    - gcloud auth activate-service-account --key-file client-secret.json
    - sed -i -e 's/'"%NLP_APIAI_TOKEN%"'/'"$NLP_APIAI_TOKEN"'/g' app.yaml
    - gcloud app deploy --project $GOOGLE_PROJECT_ID --version=beta-ci-shippable --no-stop-previous-version  --quiet

language: node_js

node_js:
  - 7

branches:
  only:
    - master-ci-shippable

env:
  global:
  - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
  - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
  - TESTS_LOC_DIR=$SHIPPABLE_REPO_DIR/test
  - MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin/
  - secure: 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
  
build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/node_modules
  ci:
    - shippable_retry npm install
    - mkdir -p $TEST_RESULTS_DIR && mkdir -p $CODE_COVERAGE_DIR
    - pushd $TESTS_LOC_DIR
    - $MOD_LOC/mocha --recursive "$TESTS_LOC_DIR/**/*.spec.js" -R mocha-junit-reporter --reporter-options mochaFile=$TEST_RESULTS_DIR/testresults.xml
    - $MOD_LOC/istanbul --include-all-sources cover $MOD_LOC/_mocha -- --recursive "$TESTS_LOC_DIR/**/*.spec.js" --ui=bdd -R xunit-file
    - $MOD_LOC/istanbul report cobertura --dir $CODE_COVERAGE_DIR
    - popd
  post_ci:
    - export CLOUDSDK_CORE_DISABLE_PROMPTS=1
      # Google Cloud SDK is pinned for build reliability. Bump if the SDK complains about deprecation.
    - SDK_FILENAME=google-cloud-sdk-$GCLOUD_SDK_VERSION-linux-x86_64.tar.gz
    - curl -O -J https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME}
    - tar -zxf ${SDK_FILENAME} --directory $HOME
    - export PATH=$HOME/google-cloud-sdk/bin:$PATH
      # Install Google App Engine SDK
      # Install app & dev dependencies, test, deploy, test deployment (--quiet --verbosity=error )
    - echo $GOOGLE_CLIENT_SECRET > client-secret.json
    - gcloud auth activate-service-account --key-file client-secret.json
    - sed -i -e 's/'"%NLP_APIAI_TOKEN%"'/'"$NLP_APIAI_TOKEN"'/g' app.yaml
    - gcloud app deploy --project $GOOGLE_PROJECT_ID --version=beta-ci-shippable --no-stop-previous-version  --quiet
